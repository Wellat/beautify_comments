# 集思录评论美化阅读器 (Jisilu Comment Beautifier) - 产品需求文档 (PRD)

## 1. 项目背景与目标
**背景**：集思录（Jisilu）网站的评论区通常包含大量层级回复，但目前的展示方式较为扁平化，导致用户在阅读长篇讨论或多层回复时，难以理清对话逻辑，阅读体验不连贯。
**目标**：开发一个Web应用，用户输入集思录文章链接后，系统自动抓取文章正文及所有评论，将评论按“盖楼”方式（嵌套结构）重新组织并展示，同时优化阅读界面，提升阅读体验。

## 2. 核心功能需求

### 2.1 输入模块
- **功能描述**：提供一个简洁的输入框，用于接收集思录文章详情页链接。
- **输入示例**：`https://www.jisilu.cn/question/517247`
- **校验规则**：
  - 必须是合法的URL。
  - 必须匹配集思录文章页面的URL模式（如 `jisilu.cn/question/`）。

### 2.2 数据抓取与处理模块 (核心)
- **抓取内容**：
  - **文章正文**：标题、作者、发布时间、正文内容（保留基本格式，如段落、图片）。
  - **评论数据**：抓取所有分页的评论。
    - 字段：评论ID、父评论ID（如有）、评论者昵称、评论内容、发布时间、回复对象。
- **数据清洗**：去除广告、无关脚本、多余的HTML标签。
- **数据重组（盖楼逻辑）**：
  - **识别父子关系**：根据评论中的“回复 @xxx”或引用的评论ID，建立父子级联关系。
  - **层级构建**：将扁平的评论列表转换为树状结构（Tree Structure）。
  - **排序规则**：
    - **一级评论（顶层）**：按发布时间正序排列（最早的在最前，或者根据用户习惯可选倒序，默认按时间正序以还原讨论过程）。
    - **子评论（楼中楼）**：按发布时间正序排列，展示在父评论下方。

### 2.3 展示模块 (UI/UX)
- **布局设计**：
  - **顶部**：搜索/输入栏（支持重新输入URL）。
  - **中间**：文章正文区域（卡片式设计，背景色区分）。
  - **下方**：评论区域。
- **评论展示风格**：
  - **盖楼样式**：采用缩进式或嵌套卡片式设计，清晰展示引用与回复关系。
  - **折叠/展开**：对于过长的回复链或子评论，支持“展开/收起”功能，避免页面过长。
  - **高亮**：楼主（文章作者）的评论可特殊高亮显示。
- **美观性**：
  - 字体：使用易读的无衬线字体。
  - 间距：增加段落和评论间的呼吸感。
  - 响应式：适配桌面端和移动端阅读。

## 3. 技术架构 (建议)

### 3.1 前端 (Frontend)
- **技术栈**：React / Vue.js / Next.js
- **职责**：
  - 接收用户输入。
  - 调用后端API获取结构化数据。
  - 渲染文章和递归渲染评论树。

### 3.2 后端 (Backend)
- **技术栈**：Python (Flask/FastAPI) 或 Node.js
- **职责**：
  - **API接口**：提供 `/api/parse?url=...` 接口。
  - **爬虫 (Scraper)**：使用 `requests` + `BeautifulSoup` 或 `Playwright` (如果需要动态渲染) 抓取集思录页面。
  - **解析器 (Parser)**：解析HTML，提取评论内容和元数据。
  - **构建器 (Builder)**：实现算法将扁平评论列表转换为树状JSON结构。

## 4. 数据结构设计 (Data Model)

### 4.1 评论对象 (Comment Item)
```json
{
  "id": "String (评论ID)",
  "author": "String (用户名)",
  "content": "String (HTML/Text)",
  "time": "String (发布时间)",
  "parent_id": "String (父评论ID, nullable)",
  "reply_to": "String (被回复人用户名, nullable)",
  "children": [ ...Comment Item... ] // 嵌套子评论
}
```

### 4.2 响应结构 (API Response)
```json
{
  "title": "文章标题",
  "author": "文章作者",
  "publish_time": "发布时间",
  "content": "文章HTML内容",
  "comments": [ ...Top Level Comment Items... ] // 已排序的一级评论列表
}
```

## 5. 开发计划与里程碑

1.  **Phase 1 (MVP)**:
    - 实现基础爬虫，能抓取单页评论。
    - 实现后端解析逻辑，将评论按“回复”关系简单归类。
    - 前端展示简单的嵌套列表。
2.  **Phase 2 (完善)**:
    - 支持多页评论抓取（集思录长贴通常有多页）。
    - 优化UI，增加折叠/展开功能。
    - 增加错误处理（如链接无效、私密帖子无法访问等）。
3.  **Phase 3 (高级)**:
    - 添加缓存机制（Redis），避免重复抓取同一链接。
    - 支持导出为PDF或Markdown。

## 6. 风险与对策
- **反爬虫机制**：集思录可能有反爬策略（如验证码、IP限制）。
  - *对策*：设置合理的请求间隔；必要时引入代理IP池或模拟浏览器行为（Selenium/Playwright）。
- **登录限制**：部分内容可能需要登录才能查看。
  - *对策*：MVP阶段仅支持公开内容；后续可考虑支持用户输入Cookie（需注意隐私安全）。
